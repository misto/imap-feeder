#!/usr/bin/env ruby

$:.unshift File.expand_path(File.join(File.dirname(__FILE__), ".."))

require 'rubygems'
require 'lib/rssimap'
require 'lib/createconfigparser'
require 'lib/rssimapconfig'
require 'lib/fakeserver.rb'

opts = CreateConfigParser.parse(ARGV)

$log = Logger.new($stdout)
$log.level = Logger::DEBUG

if opts.create
  $log.info "Creating new configuration"
  RssImapConfig.create(opts.create_file, opts.out ? File.open(opts.out, "w") : $stdout, opts.folder)
elsif opts.check
  $log.info "Checking configuration #{opts.check}"
  RssImapConfig.check(File.open(opts.check))
elsif ARGV.first && require(ARGV.first)
  configuration = [$host, $user, $pass, $temp, $config]
  if not configuration.all?
    $stderr.print "Your settings are incomplete, please review settings.rb:\n#{configuration.inspect}\n"
    exit 1
  end

  store = MessageStore.new($temp)

  server_options = {:host => $host, :user => $user, :pass => $pass, :port => $port || "143", :use_ssl => $use_ssl || false}

  if opts.pretend
    @server = FakeServer.new server_options
    def store.save() end
    $log = Logger.new STDOUT
  else
    @server = Server.new server_options
  end

  config = File.open($config)
  RssImap.new(@server, store, config).run
else
  puts "No options given, maybe you need --help?"
end

